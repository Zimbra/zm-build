
# __WAR 

MWDOWNLOAD = $(shell cd $(WEBAPP_DIR)/zimbra/downloads; ls ZCSMig*)
IWDOWNLOAD = $(shell cd $(WEBAPP_DIR)/zimbra/downloads; ls ZCSImp*)
CNDOWNLOAD = $(shell cd $(WEBAPP_DIR)/zimbra/downloads; ls ZimbraOl*)
CMDOWNLOAD = $(shell cd $(WEBAPP_DIR)/zimbra/downloads; ls ZmCus*)
ISDOWNLOAD = $(shell cd $(WEBAPP_DIR)/zimbra/downloads; ls zimbra-isync*)

$(WEBAPP_DIR)/service.war: $(WEBAPP_DIR) $(SERVICE_DIR)/$(WEBAPP_BUILD_DIR)/service.war
	mkdir $(WEBAPP_DIR)/service
	(cd $(WEBAPP_DIR)/service; jar xf $(SERVICE_DIR)/build/dist/tomcat/webapps/service.war)

$(SERVICE_DIR)/$(WEBAPP_BUILD_DIR)/service.war:
	(cd $(SERVICE_DIR); $(ANT) \
		-Dplat.tag=$(BUILD_PLATFORM) \
		-Dis-production=1 \
		-Dzimbra.buildinfo.version=$(VERSION_TAG) \
		-Dzimbra.buildinfo.release=$(RELEASE) -Dzimbra.buildinfo.date=$(DATE) \
		-Dzimbra.buildinfo.host=$(HOST) dev-dist ; )

$(WEBAPP_DIR)/zimbraAdmin.war: $(WEBAPP_DIR) $(CONSOLE_DIR)/$(WEBAPP_BUILD_DIR)/zimbraAdmin.war
	mkdir $(WEBAPP_DIR)/zimbraAdmin
	(cd $(WEBAPP_DIR)/zimbraAdmin; jar xf $(CONSOLE_DIR)/build/dist/tomcat/webapps/zimbraAdmin.war)
	for download in $(IWDOWNLOAD); do \
		echo "IMPORT_WIZ_DOWNLOAD_LINK = <A HREF=\"/zimbra/downloads/$$download\" target=_blank>Import Wizard</A>" >> $(WEBAPP_DIR)/zimbraAdmin/WEB-INF/classes/msgs/ZaMsg.properties; \
	done
	for download in $(MWDOWNLOAD); do \
		echo "MIG_WIZ_DOWNLOAD_LINK = <A HREF=\"/zimbra/downloads/$$download\" target=_blank>Migration Wizard</A>" >> $(WEBAPP_DIR)/zimbraAdmin/WEB-INF/classes/msgs/ZaMsg.properties; \
	done
	for download in $(CNDOWNLOAD); do \
		echo "CONNECTOR_DOWNLOAD_LINK = <A HREF=\"/zimbra/downloads/$$download\" target=_blank>Connector for Outlook</A>" >> $(WEBAPP_DIR)/zimbraAdmin/WEB-INF/classes/msgs/ZaMsg.properties; \
	done
	for download in $(CMDOWNLOAD); do \
		echo "CONNECTOR_MSI_DOWNLOAD_LINK = <A HREF=\"/zimbra/downloads/$$download\" target=_blank>Connector for Outlook MSI Customizer</A>" >> $(WEBAPP_DIR)/zimbraAdmin/WEB-INF/classes/msgs/ZaMsg.properties; \
	done
	for download in $(ISDOWNLOAD); do \
		echo "ISYNC_CONNECTOR_LINK = <A HREF=\"/zimbra/downloads/$$download\" target=_blank>Isync Connector</A>" >> $(WEBAPP_DIR)/zimbraAdmin/WEB-INF/classes/msgs/ZaMsg.properties; \
	done


$(CONSOLE_DIR)/$(WEBAPP_BUILD_DIR)/zimbraAdmin.war:
	(cd $(CONSOLE_DIR); $(ANT) \
		-Dplat.tag=$(BUILD_PLATFORM) \
		-Dis-production=1 \
		-Dzimbra.buildinfo.version=$(VERSION_TAG) \
		-Dzimbra.buildinfo.release=$(RELEASE) -Dzimbra.buildinfo.date=$(DATE) \
		-Dzimbra.buildinfo.host=$(HOST) clean admin-war ; )
	rm -rf zimbraAdminConf
	mkdir zimbraAdminConf
	cp $(CONSOLE_DIR)/build/WebRoot/WEB-INF/web.xml zimbraAdminConf

$(WEBAPP_DIR)/zimbra.war: $(WEBAPP_DIR) $(CONSOLE_DIR)/$(WEBAPP_BUILD_DIR)/zimbra.war
	mkdir $(WEBAPP_DIR)/zimbra
	(cd $(WEBAPP_DIR)/zimbra; jar xf $(CONSOLE_DIR)/build/dist/tomcat/webapps/zimbra.war)

$(CONSOLE_DIR)/$(WEBAPP_BUILD_DIR)/zimbra.war: 
	(cd $(CONSOLE_DIR); $(ANT) \
		-Dplat.tag=$(BUILD_PLATFORM) \
		-Dis-production=1 \
		-Dzimbra.buildinfo.version=$(VERSION_TAG) \
		-Dzimbra.buildinfo.release=$(RELEASE) -Dzimbra.buildinfo.date=$(DATE) \
		-Dzimbra.buildinfo.host=$(HOST) clean prod-war ; )
	rm -rf zimbraConf
	mkdir zimbraConf
	cp $(CONSOLE_DIR)/build/WebRoot/WEB-INF/web.xml zimbraConf

$(WEBAPP_DIR)/html.war: $(WEBAPP_DIR) $(HTMLCLIENT_DIR)/build/html.war
	mkdir $(WEBAPP_DIR)/html
	(cd $(WEBAPP_DIR)/html; jar xf $(HTMLCLIENT_DIR)/build/html.war)

$(HTMLCLIENT_DIR)/build/html.war: $(TAGLIB_DIR)/build/zimbrataglib.jar
	(cd $(HTMLCLIENT_DIR); $(ANT) \
		-Dplat.tag=$(BUILD_PLATFORM) \
		-Dis-production=1 \
		-Dzimbra.buildinfo.version=$(VERSION_TAG) \
		-Dzimbra.buildinfo.release=$(RELEASE) -Dzimbra.buildinfo.date=$(DATE) \
		-Dzimbra.buildinfo.host=$(HOST) clean war ; )

$(TAGLIB_DIR)/build/zimbrataglib.jar:
	(cd $(TAGLIB_DIR); $(ANT) \
		-Dplat.tag=$(BUILD_PLATFORM) \
		-Dis-production=1 \
		-Dzimbra.buildinfo.version=$(VERSION_TAG) \
		-Dzimbra.buildinfo.release=$(RELEASE) -Dzimbra.buildinfo.date=$(DATE) \
		-Dzimbra.buildinfo.host=$(HOST) clean jar ; )
