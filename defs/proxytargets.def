
# __PROXY

proxy: CUR_DEST_ROOT := $(PROXY_DEST_ROOT)
proxy: CUR_PACKAGE_SPEC := $(BUILD_ROOT)/zimbraproxy.spec
proxy: CUR_PACKAGE_NAME := zimbra-proxy
proxy: $(PACKAGE_DIR) proxy_stage proxy_pkg_spec_$(PACKAGE_EXT)
	(cd $(CUR_DEST_ROOT); \
	$(PACKAGING_COMMAND) $(PACKAGING_OPTIONS) )

proxy_pkg_spec_pkg: $(BUILD_ROOT)/resources/zimbra-proxy $(BUILD_ROOT)/zimbra-proxy.Info.plist $(BUILD_ROOT)/zimbra-proxy.Description.plist 

$(BUILD_ROOT)/zimbra-proxy.Description.plist:
	cat $(PACKAGE_CONF_DIR)/Spec/zimbra-proxy.Description.plist | \
		sed -e 's/@@VERSION@@/$(VERSION_TAG)/' \
		-e 's/@@RELEASE@@/$(RELEASE)/' \
		-e 's/@@MAJOR@@/$(MAJOR)/' \
		-e 's/@@MINOR@@/$(MINOR)/' > $@

$(BUILD_ROOT)/zimbra-proxy.Info.plist:
	cat $(PACKAGE_CONF_DIR)/Spec/zimbra-proxy.Info.plist | \
		sed -e 's/@@VERSION@@/$(VERSION_TAG)/' \
		-e 's/@@RELEASE@@/$(RELEASE)/' \
		-e 's/@@MAJOR@@/$(MAJOR)/' \
		-e 's/@@BUILDNUM@@/$(BUILDNUM)/' \
		-e 's/@@MINOR@@/$(MINOR)/' > $@

$(BUILD_ROOT)/resources/zimbra-proxy:
	mkdir -p $@
	cp $(PACKAGE_CONF_DIR)/Spec/Scripts/zimbra-proxy.postinstall $@/postinstall
	chmod 755 $@/postinstall
	cp $(PACKAGE_CONF_DIR)/Spec/Scripts/zimbra-proxy.postupgrade $@/postupgrade
	chmod 755 $@/postupgrade


proxy_pkg_spec_deb: $(PROXY_DEST_ROOT)/DEBIAN/control

$(PROXY_DEST_ROOT)/DEBIAN: force
	mkdir -p $@
	cp $(PACKAGE_CONF_DIR)/Spec/Scripts/zimbra.pre $@/preinst
	echo "#!/bin/bash" > $@/postinst
	echo "sh /opt/zimbra/bin/zmfixperms.sh" >> $@/postinst
	cat $(PACKAGE_CONF_DIR)/Spec/Scripts/zimbra.post >> $@/postinst
	chmod 555 $@/*

$(PROXY_DEST_ROOT)/DEBIAN/control: $(PROXY_DEST_ROOT)/DEBIAN force
	cat $(PACKAGE_CONF_DIR)/Spec/zimbraproxy.deb | \
	sed -e 's/@@VERSION@@/$(VERSION_TAG)/' \
	-e 's/@@RELEASE@@/$(RELEASE)/' \
	-e 's/@@ARCH@@/$(ARCH)/' > $@

proxy_pkg_spec_ccs:

proxy_pkg_spec_rpm: $(BUILD_ROOT)/zimbraproxy.spec

$(BUILD_ROOT)/zimbraproxy.spec:
	cp $(PACKAGE_CONF_DIR)/Spec/Scripts/zimbraproxy.pre $(BUILD_ROOT)
	cp $(PACKAGE_CONF_DIR)/Spec/Scripts/zimbraproxy.post $(BUILD_ROOT)
	cat $(PACKAGE_CONF_DIR)/Spec/zimbraproxy.spec | \
		sed -e 's/@@VERSION@@/$(VERSION_TAG)/' \
		-e 's/@@RELEASE@@/$(RELEASE)/' \
		-e 's/^Copyright:/$(RPMCOPYRIGHTSTR):/' \
		-e '/^%pre$$/ r zimbraproxy.pre' \
		-e '/^%post$$/ r zimbraproxy.post' > $(BUILD_ROOT)/zimbraproxy.spec
	rm -f zimbraproxy.pre
	rm -f zimbraproxy.post
	echo "%attr(-, zimbra, zimbra) /opt/zimbra/nginx-$(NGINX_VERSION)" >> \
		$(BUILD_ROOT)/zimbraproxy.spec
	echo "%attr(-, zimbra, zimbra) /opt/zimbra/memcached-$(MEMCACHED_VERSION)" >> \
		$(BUILD_ROOT)/zimbraproxy.spec

proxy_stage: $(PROXY_COMPONENTS)

$(PROXY_DEST_DIR):
	mkdir -p $@

$(PROXY_DEST_DIR)/$(NGINX_DIR): $(PROXY_DEST_DIR)
	@echo "*** Creating nginx"
	(cd $(PROXY_DEST_DIR); tar xzf $(NGINX_SOURCE).tgz;)

$(PROXY_DEST_DIR)/$(MEMCACHED_DIR): $(PROXY_DEST_DIR)
	@echo "*** Creating memcached"
	(cd $(PROXY_DEST_DIR); tar xzf $(MEMCACHED_SOURCE).tgz;)

$(PROXY_DEST_DIR)/lib/ext/nginx-lookup/nginx-lookup.jar: $(PROXY_DEST_DIR)/lib/ext/nginx-lookup $(NGINX_DIR)/build/nginx-lookup.jar
	cp -f $(NGINX_DIR)/build/nginx-lookup.jar

$(PROXY_DEST_DIR)/lib/ext/nginx-lookup:
	mkdir -p $@

$(NGINX_DIR)/build/nginx-lookup.jar:
        (cd $(NGINX_DIR); $(ANT) \
                -Dplat.tag=$(BUILD_PLATFORM) \
                -Dis-production=1 \
                -Dzimbra.buildinfo.version=$(VERSION_TAG) \
                -Dzimbra.buildinfo.release=$(RELEASE) -Dzimbra.buildinfo.date=$(DATE) \
                -Dzimbra.buildinfo.host=$(HOST) jar make-tar; )
